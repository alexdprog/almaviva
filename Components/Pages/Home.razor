@page "/"
@implements IDisposable
@inject NavigationManager Navigation
@inject AuthService AuthService
@inject SlotCheckService SlotCheckService
@inject CheckerStateService State
@inject AutoCheckCoordinator Coordinator

<PageTitle>Slot Checker</PageTitle>

<FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
    <FluentCard>
        <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center" HorizontalGap="10">
            <FluentButton Appearance="Appearance.Accent" OnClick="Login">Login</FluentButton>
            <FluentButton Appearance="Appearance.Stealth" OnClick="CheckNow" Disabled="@(!AuthService.IsAuthenticated)">Check Now</FluentButton>
            <FluentButton Appearance="Appearance.Accent" OnClick="StartAuto" Disabled="@(!AuthService.IsAuthenticated || State.AutoCheckingEnabled)">Start Automatic Checking</FluentButton>
            <FluentButton Appearance="Appearance.Outline" OnClick="StopAuto" Disabled="@(!State.AutoCheckingEnabled)">Stop Automatic Checking</FluentButton>
        </FluentStack>
        <p>Authorization: <strong>@(AuthService.IsAuthenticated ? "Authorized" : "Not authorized")</strong></p>
        <p>Status: <strong>@State.Status</strong></p>
        <p>Last check: <strong>@(State.LastCheckAt?.ToLocalTime().ToString("G") ?? "never")</strong></p>
    </FluentCard>

    <FluentCard>
        <h4>Found dates</h4>
        @if (State.FoundDates.Count == 0)
        {
            <p>No dates found yet.</p>
        }
        else
        {
            <FluentListbox>
                @foreach (var date in State.FoundDates)
                {
                    <FluentOption Value="@date">@date</FluentOption>
                }
            </FluentListbox>
        }
    </FluentCard>

    <FluentCard>
        <h4>Live log</h4>
        <div style="max-height: 250px; overflow: auto; background: #f4f4f4; padding: 10px; font-family: monospace;">
            @foreach (var line in State.Logs)
            {
                <div>@line</div>
            }
        </div>
    </FluentCard>
</FluentStack>

@code {
    protected override void OnInitialized()
    {
        State.Changed += OnStateChanged;
    }

    private void OnStateChanged() => InvokeAsync(StateHasChanged);

    private void Login() => Navigation.NavigateTo("/auth/login", true);

    private async Task CheckNow() => await SlotCheckService.CheckNowAsync();

    private void StartAuto()
    {
        Coordinator.Start(async ct => await SlotCheckService.CheckNowAsync(ct));
        State.SetAutoChecking(true);
        State.AddLog("Automatic checking started (interval 60 sec).");
    }

    private void StopAuto()
    {
        Coordinator.Stop();
        State.SetAutoChecking(false);
        State.AddLog("Automatic checking stopped.");
    }

    public void Dispose()
    {
        State.Changed -= OnStateChanged;
    }
}
